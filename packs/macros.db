{"_id":"MACRORANDOMITEMFROMCOMPENDIUM","name":"Get Random Item(s) from Compendium","type":"script","img":"modules/nice-cypher-add-ons/img/card_pickup.svg","scope":"global","command":"// Get all compendiums\nlet packOptions = game.packs.map(pack => `<option value=\"${pack.collection}\">${pack.title}</option>`);\n\n// Form for the GM to select in which coompendium he want to look for a random item and how many items he wants\nconst form = `  \n\t<div style=\"display: inline-block\">\n\t\t<label for=\"destinationPack\">Compendium:</label>\n\t\t<select id=\"destinationPack\" />\n\t\t\t${packOptions}\n\t\t</select>\n\t</div>\n\n\t<br>\n\n\t<div style=\"display: inline-block\">\n\t\t<label for=\"itemNum\">Number of items:</label>\n\t\t<input type=\"number\" id=\"itemNum\" required value=\"1\">\n\t</div>  \n`;\n\n// Show the form\nconst dialog = new Dialog({\n\ttitle: \"Random object(s) from compendium\",\n\tcontent: form,\n\tbuttons: {\n\t\tuse: {\n\t\t\tlabel: \"Apply\",\n\t\t\tcallback: rollInCompendium\n\t\t}\n\t}\n}).render(true);\n\n// Roll randomly X time in the compendium and whisper the result to the GM in the chat\nasync function rollInCompendium(html) {\n\tconst compendiumName = html.find(`select#destinationPack`)[0].value;\n\tconst numberOfRoll = html.find(`input#itemNum`)[0].value;\n\n\tlet c = [];\n\n\tfor (let r = 1; r <= numberOfRoll; r++) {\n\t\tgame.packs.get(compendiumName).getIndex().then(compendium => {\n\t\tlet i = Math.floor(Math.random() * compendium.size);\n\t\tlet k = Array.from(compendium.keys())[i];\n\n\t\tc.push(`@Compendium[${compendiumName}.${k}]`);\n\t\t});\n\t};\n\n\tsetTimeout(function(){\n\t\tChatMessage.create({\n\t\t\tcontent: c.toString(),\n\t\t\twhisper: game.users.contents.filter(u => u.isGM).map(u => u.id)\n\t\t});\n\n\t}, 1000);\n}","sort":100001,"permission":{"default":0},"flags":{}}
